{% extends 'base.html' %}
{% load staticfiles %}

{% block title %}
Neubs - Autorización Pedido Venta
{% endblock %}

{% block meta_description %}
Autorización Pedido de Venta - solo administradores
{% endblock %}

{% block script_head %}
<style type="text/css">
	.form-control[disabled]{
	    opacity: 1;
	    background-color: #eee;
	    color:green;
	    border-color: #eee;
}

</style>
{% endblock %}


{% block posicion_pagina %}
<ol class="breadcrumb">
    <a  href="/">Home /</a></li>
    <a class="active" href="{{ request.get_absolute_url }}">Modificar Pedido</a></li>
</ol>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
		<form class="form-horizontal" id="form-modificar">
			<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
				<h3 class="item-heading bg-grey">MODIFICAR PEDIDO VENTA</h3>
				<hr>
				<div class="form-group ">
					<label for="proveedor" class="col-lg-2 col-md-2 col-sm-2 col-xs-4 control-label">Pedido Venta</label>
					<div class="col-lg-5 col-md-5 col-sm-5 col-xs-6">
						<input type="hidden" name="idPedidoVenta" id="idPedidoVenta" required value="{{pedidoVenta.pk}}">
						<input class="form-control" type="text" name="numeroPedido" id="numeroPedido" disabled required onkeypress="return false" value="{{pedidoVenta.numeroPedido}}">
					</div>
					
					<div class="col-lg-2 col-md-4 col-sm-4 col-xs-2">
						<button type="button" id="btn-busqueda-pedido" class="form-control btn-success" style="width: 50px" data-toggle="modal" data-target="#myModal" src-url="{% url 'busqueda_venta_pedido_modal'%}">
							<span class="icon-bar glyphicon glyphicon-search icon"></span>
						</button>
					</div>
					
				</div>
				<div class="form-group">
					<label for="cliente" class="col-lg-2 col-md-2 col-sm-2 col-xs-4 control-label">Cliente</label>
					<div class="col-lg-5 col-md-5 col-sm-5 col-xs-6">
						<input class="form-control" type="text" name="cliente" id="cliente" placeholder="cliente" required onkeypress="return false" value="{{pedidoVenta.cliente}}">
					</div>
				</div>
				
			</div>
			<hr>
			<div class="col-lg-12">
				<h3 class="text-center item-heading">ITEMS DEL PEDIDO VENTA</h3>
				<div class="table-responive">
					<table id="tabla_pedido" class="table table-striped">
						<thead>
							<tr>
								<th>Producto</th>
								<th>Proveedor</th>
								<th>Cantidad</th>
								<th>Costo Total</th>
								<th>Modificar</th>
								<th>Habilitar/Deshabilitar</th>
							</tr>
						</thead>
						<tbody>
							{% for posicion in pedidoVenta.listadoPedidoVentaPosicion %}
								<tr>
									<td>{{ posicion.producto }}</td>
									<td>{{ posicion.proveedor }}</td>
									<td id="td-cantidad{{ forloop.counter }}">{{ posicion.cantidad }}</td>
									<td id="td-costo{{ forloop.counter }}">{{ posicion.costoTotal}}</td>
									<td>
										<button type="button" class="form-control btn-success center-block cursor-pointer" style="width:40px" title="Modificar" onclick="visualizar_campo_cantidad(this,{{posicion.pk}})">
											<span class="glyphicon glyphicon-edit"></span>
										</button>
									</td>
									<td>
										<button type="button" class="form-control btn-danger center-block cursor-pointer" style="width:40px" title="dehabilitar"  data-toggle="modal" data-target="#modalSubmit" data-whatever="Esta segur@ de deshabilitar la posición del pedido?" data-fercho="hoa">
											<span class="glyphicon glyphicon-remove-sign"></span>
										</button	>
									</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			
				<div id="modalSubmit" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="modalSubmitLabel">
				  <div class="modal-dialog" role="document">
				    <div class="modal-content">
				      <div class="modal-header">
				        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				        	<span aria-hidden="true">&times;</span>
				        </button>
				        <h4 class="modal-title item-heading">Alerta</h4>
				      </div>
				      <div class="modal-body">
				        <p class="item-text">¿Esta seguro de eliminar la posición del pedidó?</p>
				      </div>
				      <div class="modal-footer">
				        <button type="button" class="btn btn-default" data-dismiss="modal">No</button>
				        <button type="submit" class="btn btn-primary">Si</button>
				      </div>
				    </div><!-- /.modal-content -->
				  </div><!-- /.modal-dialog -->
				</div><!-- /.modal -->
			</div>
		</form>
	</div>
</div>

<!-- Modal -->
<div class="modal fade " id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  
</div>
{% endblock %}

{% block script_footer %} 
<link rel="stylesheet" href="{% static 'css/jquery.dataTables.min.css'%}">
<script type="text/javascript" src="{% static  'js/jquery.dataTables.min.js' %}"></script>
<script type="text/javascript">

	$(document).ready(function()
	{
		$('#tabla_pedido').DataTable({language: lenguage_spanish});
		$( "#form-modificar" ).submit(function( event ) {
		  event.preventDefault();
		});
	})
	$('#myModal').on('hidden.bs.modal', function (e) {
  		$(this).html('')
		// cuando se selecciona un pedido venta, se deben cargar las posiciones de este
  		if($("#idPedidoVenta").val()>0)
			redirect('{% url 'modificar_pedido_venta'%}?idPedidoVenta='+$("#idPedidoVenta").val())
	})
	function visualizar_campo_cantidad(btn,idPedidoPosicion){
		// Se consulta el td de la cantidad
		td_cantidad = $(btn).parent().siblings('td[id^=td-cantidad]')
		// Se consulta el td del costo
		td_costo= $(btn).parent().siblings('td[id^=td-costo]')
		costo_unitario = parseFloat($(td_costo).html()) / parseInt($(td_cantidad).html())
		// Se agregan los campos de texto
		$(td_cantidad).html("<input type='text' class='form-control' id='cantidad"+idPedidoPosicion+"' value='"+$(td_cantidad).html()+"' onkeyup='modificar_valores(this,\"#costoTotal"+idPedidoPosicion+"\",value,"+costo_unitario+")'>")
		$(td_costo).html("<input type='text' class='form-control' id='costoTotal"+idPedidoPosicion+"' value='"+$(td_costo).html()+"'>")
		// Se cambia el icono del boton
		$(btn).children('span').attr('class','glyphicon glyphicon-floppy-saved')
		// Se cambia la función onClick
		$(btn).attr('onclick',"modificar_posicion(this,"+idPedidoPosicion+")")
	}
	function modificar_valores(input,campoCostoTotal,cantidad,costoUnitario){
		if(cantidad == 0){
			toastr.error('Ingrese un numero mayor a 0','ShopNeubs')
			cantidad = 1;
		}
		$(campoCostoTotal).val(cantidad*costoUnitario)
	}
	function modificar_posicion(btn,idPedidoPosicion){

		td_cantidad = $(btn).parent().siblings('td[id^=td-cantidad]')
		// Se consulta el td del costo
		td_costo= $(btn).parent().siblings('td[id^=td-costo]')
		cantidad = $(td_cantidad).children('input').val()
		costoTotal = $(td_costo).children('input').val()

		$.ajax({
		    dataType: "json",
		    url: '/ventas/pedido/posicion/modificar/'+idPedidoPosicion+"/"+cantidad+"/"+costoTotal+"/",
		    //data: data,
		    success: function(data){
		      if (data.resultado == "True") {
		      	$(td_cantidad).html(cantidad)
				$(td_costo).html(costoTotal)
				$(btn).children('span').attr('class','glyphicon glyphicon-edit')
				$(btn).attr('onclick',"visualizar_campo_cantidad(this,"+idPedidoPosicion+")")

				toastr.success('Se ha modificado la posición con exito','ShopNeubs')
		      }
		      else
		      	toastr.error('No se ha logrado modificar la posición del pedido','ShopNeubs')	
		    },
		    error: function(jqXHR,estado,error){
		      console.log(error);
		      console.log(estado);
		    },
		  }); 	
	}
</script>
{% endblock %}